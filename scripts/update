#!/bin/bash

targetBranch="develop"
wrkDir="/home/discord/droidscord"

cd "$wrkDir" || exit 1

if ! git checkout "$targetBranch"; then
  echo "ğŸ‘¹ Oops! Failed to switch branch"

  exit 1
fi

if ! git fetch origin || ! git reset --hard "origin/$targetBranch"; then
  echo "ğŸ‘¹ Oops! Failed to clear stage"

  exit 1
fi

git clean -f

echo "[INFO] Current commit"
git show --oneline -s

echo "[INFO] Update packages"
if ! npm install; then
  echo "ğŸ‘¹ Oops! Failed to npm install"

  exit 1
fi

echo "[INFO] Build"
if ! npm run build; then
  echo "ğŸ‘¹ Oops! Failed to build"

  exit 1
fi

echo "[INFO] Clear cache"
if ! docker compose exec -it redis bash -c 'redis-cli flushall'; then
  echo "âš ï¸   Warning: Failed to clear cache"
fi

if ! docker compose ps --format "{{.Service}} {{.State}}" | grep 'llm_indexer running' || ! docker compose ps --format "{{.Service}} {{.State}}" | grep 'discordjs-bot'; then
  echo "âš ï¸  Warrning: Docker compose stack is down"
  echo "ğŸ¤– Should start compose stack, be patient..."

  if ! docker compose up -d; then
    echo "ğŸ‘¹ Oops! Failed to start compose stack"

    exit 1
  fi
fi

if ! docker compose restart; then
  echo "ğŸ‘¹ Oops! Failed to restart docker compose"

  exit 1
fi
